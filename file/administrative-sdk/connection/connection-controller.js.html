<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">administrative-sdk/_connection/_connection-controller.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>


  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>

  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>

  <a data-ice="repoURL" href="https://github.com/itslanguage/itslanguage-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>

  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">basic-auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/basic-auth/basic-auth-controller.js~BasicAuthController.html">BasicAuthController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/basic-auth/basic-auth.js~BasicAuth.html">BasicAuth</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">choice-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/choice-challenge/choice-challenge-controller.js~ChoiceChallengeController.html">ChoiceChallengeController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/choice-challenge/choice-challenge.js~ChoiceChallenge.html">ChoiceChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">choice-recognition</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/choice-recognition/choice-recognition-controller.js~ChoiceRecognitionController.html">ChoiceRecogController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/choice-recognition/choice-recognition.js~ChoiceRecognition.html">ChoiceRecognition</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">_connection</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/connection/connection-controller.js~Connection.html">Connection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">organisation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/organisation/organisation-controller.js~OrganisationController.html">OrganisationController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/organisation/organisation.js~Organisation.html">Organisation</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">phoneme</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/phoneme/phoneme.js~Phoneme.html">Phoneme</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">pronunciation-analysis</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/pronunciation-analysis/pronunciation-analysis-controller.js~PronunciationAnalysisController.html">PronunciationAnalysisController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/pronunciation-analysis/pronunciation-analysis.js~PronunciationAnalysis.html">PronunciationAnalysis</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">pronunciation-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/pronunciation-challenge/pronunciation-challenge-controller.js~PronunciationChallengeController.html">PronunciationChallengeController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/pronunciation-challenge/pronunciation-challenge.js~PronunciationChallenge.html">PronunciationChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">speech-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/speech-challenge/speech-challenge-controller.js~SpeechChallengeController.html">SpeechChallengeController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/speech-challenge/speech-challenge.js~SpeechChallenge.html">SpeechChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">speech-recording</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/speech-recording/speech-recording-controller.js~SpeechRecordingController.html">SpeechRecordingController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/speech-recording/speech-recording.js~SpeechRecording.html">SpeechRecording</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">student</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/student/student-controller.js~StudentController.html">StudentController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/student/student.js~Student.html">Student</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">tenant</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/tenant/tenant-controller.js~TenantController.html">TenantController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/tenant/tenant.js~Tenant.html">Tenant</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/utils/base64-utils.js~Base64Utils.html">Base64Utils</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">word</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/word/word.js~Word.html">Word</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">word-chunk</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/administrative-sdk/word-chunk/word-chunk.js~WordChunk.html">WordChunk</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">administrative-sdk/_connection/_connection-controller.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* eslint-disable
camelcase
 */

import autobahn from &apos;autobahn&apos;;
import ee from &apos;event-_emitter&apos;;
/**
 * Controller class for managing _connection interaction.
 */
export default class Connection {

  /**
   *
   * @param {Object} options - Options to configure the _connection with.
   * Valid options include:
   * * apiUrl - The URL of the REST api.
   * * wsUrl - The URL of the Websocket server.
   * * oAuth2Token - An OAuth2 token string.
   * * adminPrincipal - The username of the admin account.
   * * adminPassword - The password of the admin account.
   */
  constructor(options) {
    /**
     * @type {Object}
     */
    this.settings = Object.assign({
      // ITSL _connection parameters.
      apiUrl: &apos;https://api.itslanguage.nl&apos;,
      oAuth2Token: null,
      wsUrl: null,
      wsToken: null
    }, options);
    Connection._sdkCompatibility();
    this._analysisId = null;
    this._recordingId = null;
    this._recognitionId = null;
    this._emitter = ee({});
  }

  /**
   * Add an event listener. Listens to events emitted from the websocket server _connection.
   *
   * @param {string} name - Name of the event.
   * @param {Function} handler - Handler function to add.
   */
  addEventListener(name, handler) {
    this._emitter.on(name, handler);
  }

  /**
   * Remove an event listener of the websocket _connection.
   *
   * @param {string} name - Name of the event.
   * @param {Function} handler - Handler function to remove.
   */
  removeEventListener(name, handler) {
    this._emitter.off(name, handler);
  }

  /**
   * Fire an event.
   *
   * @param {string} name - Name of the event.
   * @param {[]} args - Arguments.
   * @private
   */
  fireEvent(name, args = []) {
    this._emitter.emit(name, ...args);
  }

  /**
   * Assemble a HTTP Authentication header.
   *
   * @returns {Promise} Promise containing an authorization header string.
   * @throws {Promise} If the oAuth2Token in {@link Connection#settings} is not set.
   */
  _getAuthHeaders() {
    if (!this.settings.oAuth2Token) {
      return Promise.reject(&apos;Please set oAuth2Token&apos;);
    }
    const authHeader = &apos;Bearer &apos; + this.settings.oAuth2Token;
    return Promise.resolve(authHeader);
  }

  /**
   * Create a _connection to the websocket server.
   *
   */
  webSocketConnect() {
    const self = this;
    /**
     * This callback is fired during Ticket-based authentication.
     *
     * @param {Session} session - Session.
     * @param {string} method - Authentication method.
     */
    function onOAuth2Challenge(session, method) {
      if (method === &apos;ticket&apos;) {
        return self.settings.oAuth2Token;
      }
      throw new Error(`don&apos;t know how to authenticate using &apos;${method}&apos;`);
    }

    const authUrl = this.settings.wsUrl;
    let _connection = null;
    // Open a websocket _connection for streaming audio
    try {
      // Set up WAMP _connection to router
      _connection = new autobahn.Connection({
        url: authUrl,
        realm: &apos;default&apos;,
        // the following attributes must be set for Ticket-based authentication
        authmethods: [&apos;ticket&apos;],
        authid: &apos;oauth2&apos;,
        details: {
          ticket: this.settings.oAuth2Token
        },
        onchallenge: onOAuth2Challenge
      });
    } catch (e) {
      console.log(&apos;WebSocket creation error: &apos; + e);
      return;
    }
    _connection.onerror = function(e) {
      console.log(&apos;WebSocket error: &apos; + e);
      self.fireEvent(&apos;websocketError&apos;, [e]);
    };
    _connection.onopen = function(session) {
      console.log(&apos;WebSocket _connection opened&apos;);
      self._session = session;
      const _call = self._session.call;
      self._session.call = function(url, ...args) {
        console.debug(&apos;Calling RPC: &apos; + url);
        return _call.call(this, url, ...args);
      };
      self.fireEvent(&apos;websocketOpened&apos;);
    };
    _connection.onclose = function() {
      console.log(&apos;WebSocket disconnected&apos;);
      self._session = null;
      self.fireEvent(&apos;websocketClosed&apos;);
    };
    _connection.open();
  }

  /**
   * Perform a HTTP GET to the API using authentication.
   *
   * @param {string} url - Url to retrieve.
   * @returns {Promise} Promise containing a result.
   * @throws {Promise} If the server returned an error.
   */
  _secureAjaxGet(url) {
    return this._getAuthHeaders()
      .then(auth =&gt; {
        const headers = new Headers();
        headers.append(&apos;Authorization&apos;, auth);
        const options = {
          method: &apos;GET&apos;,
          headers
        };
        return fetch(url, options)
          .then(this.handleResponse);
      });
  }

  /**
   * Perform a HTTP POST to the API using authentication.
   *
   * @param {string} url - Url to submit to.
   * @param {FormData} formdata - The form to POST.
   * @returns {Promise} Promise containing a result.
   * @throws {Promise} If the server returned an error.
   */
  _secureAjaxPost(url, formdata) {
    return this._getAuthHeaders()
      .then(auth =&gt; {
        const headers = new Headers();
        headers.append(&apos;Authorization&apos;, auth);
        if (typeof formdata === &apos;string&apos;) {
          headers.append(&apos;Content-Type&apos;,
            &apos;application/json; charset=utf-8&apos;);
        }
        const options = {
          method: &apos;POST&apos;,
          headers,
          body: formdata
        };
        return fetch(url, options)
          .then(this.handleResponse);
      });
  }

  /**
   * Perform a HTTP DELETE to the API using authentication.
   *
   * @param {string} url - Url to submit to.
   * @returns {Promise} Promise containing a result.
   * @throws {Promise} If the server returned an error.
   */
  _secureAjaxDelete(url) {
    return this._getAuthHeaders()
      .then(auth =&gt; {
        const headers = new Headers();
        headers.append(&apos;Authorization&apos;, auth);
        const options = {
          method: &apos;DELETE&apos;,
          headers
        };
        return fetch(url, options)
          .then(this.handleResponse);
      });
  }

  handleResponse(response) {
    return response.text()
          .then(textResponse =&gt; {
            if (!textResponse) {
              return Promise.reject(response.status + &apos;: &apos; + response.statusText);
            }
            const result = JSON.parse(textResponse);
            if (response.ok) {
              return result;
            }
            return Promise.reject(result);
          });
  }

  /**
   * Add an access token to the given URL.
   *
   * @param {string} url - The URL to add an access token to.
   * @returns {string} An url with the access token appended.
   */
  addAccessToken(url) {
    if (!this.settings.oAuth2Token) {
      throw new Error(&apos;Please set oAuth2Token&apos;);
    }
    const secureUrl = url + (url.match(/\?/) ? &apos;&amp;&apos; : &apos;?&apos;) + &apos;access_token=&apos; +
      encodeURIComponent(this.settings.oAuth2Token);
    return secureUrl;
  }

  /**
   * Logs browser compatibility for required and optional SDK capabilities.
   *
   * @throws {Error} In case of compatibility issues.
   */
  static _sdkCompatibility() {
    // WebSocket
    // http://caniuse.com/#feat=websockets
    const canCreateWebSocket = &apos;WebSocket&apos; in window;
    console.log(&apos;Native WebSocket capability: &apos; +
      canCreateWebSocket);

    if (!canCreateWebSocket) {
      throw new Error(&apos;No WebSocket capabilities&apos;);
    }
  }

  /**
   * Cancel any current streaming audio recording.
   *
   * @param {AudioRecorder} recorder - The audio recorder currently recording.
   */
  cancelStreaming(recorder) {
    const self = this;

    if (this._recordingId === null &amp;&amp; this._analysisId === null &amp;&amp; this._recognitionId === null) {
      console.info(&apos;No session in progress, nothing to cancel.&apos;);
      return;
    }

    recorder.removeAllEventListeners();
    if (recorder.isRecording()) {
      recorder.stop();
    }

    // This session is over.
    self._recordingId = null;
    self._analysisId = null;
    self._recognitionId = null;
  }

  /**
   * Log an error caught from an RPC call.
   *
   * @param {Object} result - Error object.
   */
  static logRPCError(result) {
    console.error(&apos;RPC error returned:&apos;, result.error);
  }

  /**
   * Ask the server for an OAuth2 token.
   *
   * @param {BasicAuth} basicAuth - Basic Auth to obtain credentials from.
   * @param {Organisation#id} organisationId - Id of the organisation to request a token for.
   * @param {Student#id} studentId - Id of the student to request a token for.
   * @returns {Promise} Promise containing a access_token, token_type and scope.
   * @throws {Promise} If the server returned an error.
   */
  getOauth2Token(basicAuth, organisationId, studentId) {
    const url = this.settings.apiUrl + &apos;/tokens&apos;;
    let scopes = &apos;tenant/&apos; + basicAuth.tenantId;
    if (organisationId) {
      scopes += &apos;/organisation/&apos; + organisationId;
    }
    if (organisationId &amp;&amp; studentId) {
      scopes += &apos;/student/&apos; + studentId;
    }
    const headers = new Headers();
    headers.append(&apos;Content-Type&apos;,
      &apos;application/x-www-form-urlencoded; charset=utf8&apos;);
    const formData = &apos;grant_type=password&amp;scope=&apos; + scopes +
      &apos;&amp;username=&apos; + basicAuth.principal +
      &apos;&amp;password=&apos; + basicAuth.credentials;
    const options = {
      method: &apos;POST&apos;,
      headers,
      body: formData
    };
    return fetch(url, options)
      .then(response =&gt;
        response.json()
          .then(data =&gt; {
            if (response.ok) {
              this.settings.oAuth2Token = data.access_token;
              return data;
            }
            throw data;
          })
      );
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
