<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/audio/audio-player.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/itslanguage/itslanguage-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools.js~Stopwatch.html">Stopwatch</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/administrative-sdk.js~AdministrativeSDK.html">AdministrativeSDK</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/basic-auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/basic-auth/basic-auth.js~BasicAuth.html">BasicAuth</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/choice-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/choice-challenge/choice-challenge.js~ChoiceChallenge.html">ChoiceChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/choice-recognition</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/choice-recognition/choice-recognition.js~ChoiceRecognition.html">ChoiceRecognition</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/connection</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/connection/connection-controller.js~Connection.html">Connection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/organisation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/organisation/organisation.js~Organisation.html">Organisation</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/phoneme</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/phoneme/phoneme.js~Phoneme.html">Phoneme</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/pronunciation-analysis</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/pronunciation-analysis/pronunciation-analysis.js~PronunciationAnalysis.html">PronunciationAnalysis</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/pronunciation-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/pronunciation-challenge/pronunciation-challenge.js~PronunciationChallenge.html">PronunciationChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/speech-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/speech-challenge/speech-challenge.js~SpeechChallenge.html">SpeechChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/speech-recording</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/speech-recording/speech-recording.js~SpeechRecording.html">SpeechRecording</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/student</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/student/student.js~Student.html">Student</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/utils/base64-utils.js~Base64Utils.html">Base64Utils</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/word</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/word/word.js~Word.html">Word</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/word-chunk</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/word-chunk/word-chunk.js~WordChunk.html">WordChunk</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">audio</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-player.js~AudioPlayer.html">AudioPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-recorder.js~AudioRecorder.html">AudioRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-tools.js~VolumeMeter.html">VolumeMeter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/cordova-media-player.js~CordovaMediaPlayer.html">CordovaMediaPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/cordova-media-recorder.js~CordovaMediaRecorder.html">CordovaMediaRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/media-recorder.js~MediaRecorder.html">MediaRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/web-audio-player.js~WebAudioPlayer.html">WebAudioPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/web-audio-recorder.js~WebAudioRecorder.html">WebAudioRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateWaveSample">generateWaveSample</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/audio/audio-player.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import CordovaMediaPlayer from &apos;./cordova-media-player&apos;;
import Stopwatch from &apos;../tools&apos;;
import WebAudioPlayer from &apos;./web-audio-player&apos;;
import allOff from &apos;event-emitter/all-off&apos;;
import ee from &apos;event-emitter&apos;;
/**
 * ITSLanguage AudioPlayer non-graphical component.
 */
export default class AudioPlayer {
  /**
   * Construct an AudioPlayer for playing .wav or .mp3 files.
   *
   * @param {Object} [options] - Override any of the default settings.
   * @emits {Event} &apos;playbackstopped&apos; When playback has ended, been stopped or been paused.
   * @emits {Event} All events the HTML5 Audio also fires. {@link http://www.w3schools.com/tags/ref_av_dom.asp}
   */
  constructor(options) {
    this._settings = Object.assign({}, options);

    this._playbackCompatibility();
    const self = this;
    const callbacks = {
      playingCb() {
        self._emitter.emit(&apos;playing&apos;, []);
      },
      timeupdateCb() {
        self._emitter.emit(&apos;timeupdate&apos;, []);
      },
      durationchangeCb() {
        self._emitter.emit(&apos;durationchange&apos;, []);
      },
      canplayCb() {
        self._emitter.emit(&apos;canplay&apos;, []);
      },
      endedCb() {
        self._emitter.emit(&apos;ended&apos;, []);
      },
      pauseCb() {
        self._emitter.emit(&apos;pause&apos;, []);
      },
      stoppedCb() {
        self._emitter.emit(&apos;stopped&apos;, []);
      },
      playbackStoppedCb() {
        self._emitter.emit(&apos;playbackstopped&apos;, []);
        if (self._stopwatch) {
          self._stopwatch.stop();
        }
      },
      progressCb() {
        self._emitter.emit(&apos;progress&apos;, []);
      },
      errorCb() {
        self._emitter.emit(&apos;error&apos;, []);
      }
    };
    /**
     * @type {CordovaMediaPlayer|WebAudioPlayer} player - Specific audio player.
     */
    this._player = this._getBestPlayer(callbacks);
    this._emitter = ee({});
    this._stopwatch = null;
  }

  /**
   * Turn off all event listeners for this player.
   */
  resetEventListeners() {
    allOff(this._emitter);
  }

  /**
   * Add an event listener. Listens to events emitted from the player.
   *
   * @param {string} name - Name of the event.
   * @param {Function} handler - Handler function to add.
   */
  addEventListener(name, handler) {
    this._emitter.on(name, handler);
  }

  /**
   * Remove an event listener of the player.
   *
   * @param {string} name - Name of the event.
   * @param {Function} handler - Handler function to remove.
   */
  removeEventListener(name, handler) {
    this._emitter.off(name, handler);
  }

  /**
   * Check for mandatory browser compatibility.
   * Logs detailed browser compatibilities related to for audio playback.
   *
   * @throws {Error} If no native wave or MP3 playback is available.
   */
  _playbackCompatibility() {
    // Detect audio playback capabilities.

    // Detect HTML5 Audio playback.
    // http://caniuse.com/#feat=audio
    this.canUseAudio = Boolean(Audio);
    console.log(&apos;Native HTML5 Audio playback capability: &apos; +
      this.canUseAudio);

    // Detect Cordova Media Playback
    // It allows playing audio using the native bridge inside WebView Apps.
    // https://github.com/apache/cordova-plugin-media/blob/master/doc/index.md
    this.canUseCordovaMedia = Boolean(window.Media);
    console.log(&apos;Cordova Media playback capability: &apos; +
      this.canUseCordovaMedia);

    if (!this.canUseAudio &amp;&amp; !this.canUseCordovaMedia) {
      throw new Error(
        &apos;Some form of audio playback capability is required&apos;);
    }
    if (this.canUseAudio) {
      const _audio = new Audio();
      if (!(_audio.canPlayType &amp;&amp; _audio.canPlayType instanceof Function)) {
        throw new Error(
          &apos;Unable to detect audio playback capabilities&apos;);
      }
      const canPlayOggVorbis = _audio.canPlayType(
          &apos;audio/ogg; codecs=&quot;vorbis&quot;&apos;) !== &apos;&apos;;
      const canPlayOggOpus = _audio.canPlayType(
          &apos;audio/ogg; codecs=&quot;opus&quot;&apos;) !== &apos;&apos;;
      const canPlayWave = _audio.canPlayType(&apos;audio/wav&apos;) !== &apos;&apos;;
      const canPlayMP3 = _audio.canPlayType(&apos;audio/mpeg; codecs=&quot;mp3&quot;&apos;) !== &apos;&apos;;
      const canPlayAAC = _audio.canPlayType(
          &apos;audio/mp4; codecs=&quot;mp4a.40.2&quot;&apos;) !== &apos;&apos;;
      const canPlay3GPP = _audio.canPlayType(
          &apos;audio/3gpp; codecs=&quot;samr&quot;&apos;) !== &apos;&apos;;

      console.log(&apos;Native Vorbis audio in Ogg container playback capability: &apos; +
        canPlayOggVorbis);
      console.log(&apos;Native Opus audio in Ogg container playback capability: &apos; +
        canPlayOggOpus);
      console.log(&apos;Native PCM audio in Waveform Audio File Format (WAVE) &apos; +
        &apos;playback capability: &apos; + canPlayWave);
      console.log(&apos;Native MPEG Audio Layer 3 (MP3) playback capability: &apos; +
        canPlayMP3);
      console.log(&apos;Native Low-Complexity AAC audio in MP4 container playback &apos; +
        &apos;capability: &apos; + canPlayAAC);
      console.log(&apos;Native AMR audio in 3GPP container playback capability: &apos; +
        canPlay3GPP);

      if (!(canPlayWave || canPlayMP3)) {
        throw new Error(
          &apos;Native Wave or MP3 playback is required&apos;);
      }
    }
  }

  /**
   * Get a player object that performs audio compression, when available.
   *
   * Using the Media Stream Recording API for recording is the preferred
   * solution. It allows recording compressed audio which makes it quicker to
   * submit. If not available, use a default createScriptProcessor is used.
   *
   * @param {Function} callbacks - Callbacks to add to the chosen player.
   * @private
   */
  _getBestPlayer(callbacks) {
    let player = null;
    // Start by checking for a Cordova environment.
    // When running under a debugger like Ripple, both Cordova and WebAudio
    // environments get detected. While this is technically valid -Ripple is
    // running in Chrome, which supports WebAudio-, it&apos;s not a sandbox that
    // also disables functionality that would not be available on a device.
    if (this.canUseCordovaMedia) {
      // Use Cordova audio encoding (used codec depends on the platform).
      player = new CordovaMediaPlayer(callbacks);
    } else if (this.canUseAudio) {
      // Use the recorder with MediaRecorder implementation.
      player = new WebAudioPlayer(callbacks);
    } else {
      throw new Error(&apos;Unable to find a proper player.&apos;);
    }
    console.log(&apos;Player initialised.&apos;);
    return player;
  }

  /**
   * Preload audio from an URL.
   *
   * @param {string} url - The URL that contains the audio.
   * @param {boolean} [preload=true] - Try preloading metadata and possible some audio. Set to false to not download
   * anything until playing.
   * @param {Function} [loadedCb] - The callback that is invoked when the duration of the audio file
   * is first known.
   * @emits {Event} &apos;canplay&apos; When the player is ready to play.
   */
  load(url, preload, loadedCb) {
    this.reset();
    this._player.load(url, preload, loadedCb);

    // If preloading is disabled, the &apos;canplay&apos; event won&apos;t be triggered.
    // In that case, fire it manually.
    if (!preload) {
      this._emitter.emit(&apos;canplay&apos;, []);
    }
  }

  /**
   * Unload previously loaded audio. Stops the player and any stopwatch.
   *
   * @emits {Event} &apos;unloaded&apos;
   */
  reset() {
    this.stop();
    this._player.reset();
    this._emitter.emit(&apos;unloaded&apos;, []);
  }

  /**
   * Start or continue playback of audio. Also starts the stopwatch at the given position.
   *
   * @param {number} [position] - When position is given, start playing from this position (seconds).
   */
  play(position) {
    if (this._player.isPlaying()) {
      return;
    }
    this._player.play(position);
    if (this._stopwatch) {
      const time = Math.round(this._player.getCurrentTime() * 10);
      this._stopwatch._value = time;
      this._stopwatch.start();
    }
  }

  /**
   * Stop playback of audio. Stops and resets the stopwatch.
   */
  stop() {
    if (this._stopwatch) {
      this._stopwatch.reset();
      this._stopwatch.stop();
    }
    this._player.stop();
  }

  /**
   * Pause playback of audio. Stops the stopwatch.
   */
  pause() {
    if (this._stopwatch) {
      this._stopwatch.stop();
    }
    this._player.pause();
  }

  /**
   * Toggle audio playback. Switch from playing to paused state and back.
   */
  togglePlayback() {
    if (this._player.isPlaying()) {
      this.pause();
    } else {
      this.play();
    }
  }

  /**
   * Start preloading audio.
   */
  preload() {
    this._player.preload();
  }

  /**
   * Start playing audio at the given offset. Corrects a percentage under 0 or above 100 to the respective values.
   *
   * @param {number} percentage - Start at this percentage (0..100) of the audio stream.
   */
  scrub(percentage) {
    if (percentage &lt; 0) {
      this._player.scrub(0);
    } else if (percentage &gt; 100) {
      this._player.scrub(100);
    } else {
      this._player.scrub(percentage);
    }
    if (this._stopwatch) {
      this._stopwatch._value = Math.round(this._player.getCurrentTime() * 10);
    }
  }

  /**
   * Returns the percentage of which the buffer is filled.
   *
   * @returns {number} Percentage of buffer fill.
   */
  getBufferFill() {
    return this._player.getBufferFill();
  }

  /**
   * Returns the current playing time as offset in seconds from the start.
   *
   * @returns {number} Time in seconds as offset from the start.
   */
  getCurrentTime() {
    return this._player.getCurrentTime();
  }

  /**
   * Returns the total duration in seconds.
   *
   * @returns {number} Time in seconds of fragment duration.
   */
  getDuration() {
    return this._player.getDuration();
  }

  /**
   * Check if there is playback in progress.
   *
   * @returns {boolean} True if user is currently playing audio. False otherwise.
   */
  isPlaying() {
    return this._player.isPlaying();
  }

  /**
   * Returns ready state of the player.
   *
   * @returns {boolean} True when player is ready to start loading data or play. False when no audio is loaded
   * or the player is preparing.
   */
  canPlay() {
    return this._player.canPlay();
  }

  /**
   * Bind a stopwatch to sync with the playing and stopping functionality of the player.
   *
   * @param {Function} tickCb - Callback to invoke on every tick. A tick occurs once every 100 ms.
   * @throws {Error} If _tickCb is null.
   * @returns {Stopwatch} New Stopwatch object.
   */
  bindStopwatch(tickCb) {
    this._stopwatch = new Stopwatch(time =&gt; {
      const duration = this.getDuration() * 10;
      if (time &gt; duration) {
        tickCb(duration);
      } else {
        tickCb(time);
      }
    });
    return this._stopwatch;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
