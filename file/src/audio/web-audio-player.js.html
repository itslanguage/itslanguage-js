<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/audio/web-audio-player.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/itslanguage/itslanguage-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tools.js~Stopwatch.html">Stopwatch</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/administrative-sdk.js~AdministrativeSDK.html">AdministrativeSDK</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/basic-auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/basic-auth/basic-auth.js~BasicAuth.html">BasicAuth</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/choice-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/choice-challenge/choice-challenge.js~ChoiceChallenge.html">ChoiceChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/choice-recognition</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/choice-recognition/choice-recognition.js~ChoiceRecognition.html">ChoiceRecognition</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/connection</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/connection/connection-controller.js~Connection.html">Connection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/organisation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/organisation/organisation.js~Organisation.html">Organisation</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/phoneme</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/phoneme/phoneme.js~Phoneme.html">Phoneme</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/pronunciation-analysis</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/pronunciation-analysis/pronunciation-analysis.js~PronunciationAnalysis.html">PronunciationAnalysis</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/pronunciation-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/pronunciation-challenge/pronunciation-challenge.js~PronunciationChallenge.html">PronunciationChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/speech-challenge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/speech-challenge/speech-challenge.js~SpeechChallenge.html">SpeechChallenge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/speech-recording</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/speech-recording/speech-recording.js~SpeechRecording.html">SpeechRecording</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/student</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/student/student.js~Student.html">Student</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/utils/base64-utils.js~Base64Utils.html">Base64Utils</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/word</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/word/word.js~Word.html">Word</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">administrative-sdk/word-chunk</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/administrative-sdk/word-chunk/word-chunk.js~WordChunk.html">WordChunk</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">audio</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-player.js~AudioPlayer.html">AudioPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-recorder.js~AudioRecorder.html">AudioRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/audio-tools.js~VolumeMeter.html">VolumeMeter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/cordova-media-player.js~CordovaMediaPlayer.html">CordovaMediaPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/cordova-media-recorder.js~CordovaMediaRecorder.html">CordovaMediaRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/media-recorder.js~MediaRecorder.html">MediaRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/web-audio-player.js~WebAudioPlayer.html">WebAudioPlayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/audio/web-audio-recorder.js~WebAudioRecorder.html">WebAudioRecorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateWaveSample">generateWaveSample</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/audio/web-audio-player.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @title ITSLanguage Javascript Audio
 * @overview This is part of the ITSLanguage Javascript SDK to perform audio related functions.
 * @copyright (c) 2014 ITSLanguage
 * @license MIT
 * @author d-centralize
 *
 * This class fires the same events as the HTML5 Audio does. {@link http://www.w3schools.com/tags/ref_av_dom.asp}
 */

export default class WebAudioPlayer {
  /**
   * ITSLanguage WebAudioPlayer non-graphical component.
   *
   * This player uses the HTML5 Audio component for playback.
   *
   * @param {Object} [options] - Override any of the default settings.
   */
  constructor(options) {
    this._settings = Object.assign({}, options);

    this._initPlayer();
  }

  _initPlayer() {
    this.sound = new window.Audio();
    this._pauseIsStop = false;

    // The its.AudioPlayer API is based upon the same API calls as the
    // HTML5 Audio element itself, therefore, just bubble up all events.
    const self = this;

    this.sound.addEventListener(&apos;playing&apos;, () =&gt; {
      if (self._settings.playingCb) {
        self._settings.playingCb();
      }
    });

    this.sound.addEventListener(&apos;timeupdate&apos;, () =&gt; {
      if (self._settings.timeupdateCb) {
        self._settings.timeupdateCb();
      }
    });

    this.sound.addEventListener(&apos;durationchange&apos;, () =&gt; {
      if (self._settings.durationchangeCb) {
        self._settings.durationchangeCb();
      }
    });

    this.sound.addEventListener(&apos;canplay&apos;, () =&gt; {
      if (self._settings.canplayCb) {
        self._settings.canplayCb();
      }
    });

    this.sound.addEventListener(&apos;ended&apos;, () =&gt; {
      if (self._settings.endedCb) {
        self._settings.endedCb();
      }
    });

    this.sound.addEventListener(&apos;pause&apos;, () =&gt; {
      // The HTML5 audio player only has a pause(), no stop().
      // To differentiate between the two, a flag is set in case the user
      // explicitly stopped (not paused) the audio.
      if (self._pauseIsStop === true) {
        self._pauseIsStop = false;
        if (self._settings.pauseCb) {
          self._settings.pauseCb();
        }
      } else if (self._settings.stoppedCb) {
        self._settings.stoppedCb();
      }
      if (self._settings.playbackStoppedCb) {
        self._settings.playbackStoppedCb();
      }
    });

    this.sound.addEventListener(&apos;progress&apos;, () =&gt; {
      if (self._settings.progressCb) {
        self._settings.progressCb();
      }
    });

    this.sound.addEventListener(&apos;error&apos;, e =&gt; {
      switch (e.target.error.code) {
        case e.target.error.MEDIA_ERR_ABORTED:
          console.error(&apos;You aborted the playback.&apos;);
          break;
        case e.target.error.MEDIA_ERR_NETWORK:
          console.error(
          &apos;A network error caused the audio download to fail.&apos;);
          break;
        case e.target.error.MEDIA_ERR_DECODE:
          console.error(
          &apos;The audio playback was aborted due to a corruption &apos; +
          &apos;problem or because the media used features your &apos; +
          &apos;browser did not support.&apos;);
          break;
        case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
          console.error(
          &apos;The audio could not be loaded, either because the &apos; +
          &apos;server or network failed or because the format is &apos; +
          &apos;not supported.&apos;);
          break;
        default:
          console.error(&apos;An unknown error occurred.&apos;);
          break;
      }
      if (self._settings.errorCb) {
        self._settings.errorCb();
      }
    });
  }


  /**
   * Preload audio from an URL.
   *
   * @param {string} url - The URL that contains the audio.
   * @param {boolean} [preload=true] - Try preloading metadata and possible some audio (default).
   * Set to false to not download anything until playing.
   * @param {Function} [loadedCb] - The callback that is invoked when the duration of the audio file
   * is first known.
   */
  load(url, preload, loadedCb) {
    preload = preload === undefined ? true : preload;

    // Automatically begin buffering the file, even if autoplay is off.
    this.sound.autobuffer = Boolean(preload);

    // Preloading options:
    // none - Do not preload any media.
    // Wait for a play event before downloading anything.
    // metadata - Preload just the metadata. Grab the start and the end of
    // the file via range-request and determine the duration.
    // auto - Preload the whole file. Grab the start and the end of the
    // file to determine duration, then seek back to the start
    // again for the preload proper.
    this.sound.preload = preload ? &apos;auto&apos; : &apos;none&apos;;

    const self = this;
    if (loadedCb) {
      this.sound.addEventListener(&apos;durationchange&apos;, () =&gt; {
        console.log(&apos;Duration change for &apos; + url + &apos; to : &apos; +
          self.sound.duration);
        loadedCb(self.sound);
      });
    }

    this.sound.src = url;
  }


  /**
   * Start or continue playback of audio.
   *
   * @param {number} [position] - When position is given, start playing from this position (seconds).
   */
  play(position) {
    if (position !== undefined) {
      if (this.sound.readyState &lt; this.sound.HAVE_METADATA) {
        // In case the audio wasn&apos;t already preloaded, do it now.
        this.sound.preload = &apos;auto&apos;;
        console.warn(&apos;Playing from a given position is not possible. &apos; +
          &apos;Audio was not yet loaded. Try again.&apos;);
      } else {
        console.debug(&apos;Scrub position to: &apos; + position);
        this.sound.currentTime = position;
      }
    }
    console.debug(&apos;Start playing from position: &apos; + this.sound.currentTime);
    this.sound.play();
  }

  /**
   * Unload previously loaded audio.
   */
  reset() {
    this._initPlayer();
  }

  /**
   * Stop playback of audio.
   */
  stop() {
    // The HTML5 audio player only has a pause(), no stop().
    // To differentiate between the two, set a flag.
    this.sound.pause();
    this.sound.currentTime = 0;
  }

  /**
   * Pause playback of audio.
   */
  pause() {
    this._pauseIsStop = true;
    this.sound.pause();
  }

  /**
   * Start preloading audio.
   */
  preload() {
    // In case the audio wasn&apos;t already preloaded, do it now.
    if (this.sound.preload !== &apos;auto&apos;) {
      console.info(&apos;Start preloading audio.&apos;);
      this.sound.preload = &apos;auto&apos;;
    }
  }


  /**
   * Start playing audio at the given offset.
   *
   * @param {number} percentage - Start at this percentage (0..100) of the audio stream.
   */
  scrub(percentage) {
    // In case the audio wasn&apos;t already preloaded, do it now.
    if (this.sound.readyState &lt; this.sound.HAVE_METADATA) {
      this.preload();
      console.warn(&apos;Scrubbing not possible. Audio was not yet loaded. &apos; +
        &apos;Try again.&apos;);
      return;
    }

    const newTime = this.sound.duration / 100 * percentage;
    console.log(&apos;Moving audio position to: &apos; + percentage + &apos;%: &apos; +
      newTime + &apos;s of total playing time: &apos; + this.sound.duration);
    this.sound.currentTime = newTime;
  }

  /**
   * Returns the percentage of which the buffer is filled.
   *
   * @returns {number} Percentage of buffer fill.
   */
  getBufferFill() {
    if (this.sound.buffered === undefined ||
      this.sound.buffered.length === 0) {
      // Nothing buffered yet.
      return 0;
    }

    // The fact that there&apos;s not one buffer segment is ignored here.
    // Truely representing the buffered state requires multiple
    // loading bars.
    // Usually, when user didn&apos;t seek yet, there are two segments:
    // Got segment from: 0 to: 187.63999938964844
    // Got segment from: 222.44700622558594 to: 228.1140899658203
    // The latter is gained when the HTML5 audio component tries to find
    // the total audio duration.
    // More info:
    // http://html5doctor.com/html5-audio-the-state-of-play/#time-ranges
    let probableEnd = 0;
    for (let i = 0; i &lt; this.sound.buffered.length; i++) {
      const start = this.sound.buffered.start(i);
      const end = this.sound.buffered.end(i);
      // console.log(&apos;Got segment from: &apos; + start + &apos; to: &apos; + end);
      // Often, the segment that starts from 0 keeps growing and
      // indicates -most likely- the biggest buffer.
      if (start === 0) {
        probableEnd = end;
      }
    }

    // Round up,so the buffer won&apos;t get stuck on 99% when
    // duration and buffer are equal, except for some far decimal.
    const loaded = Math.round(probableEnd * 100 / this.sound.duration);
    console.log(&apos;Buffer filled to &apos; + loaded + &apos;%&apos;);
    return loaded;
  }

  /**
   * Returns the current playing time as offset in seconds from the start.
   *
   * @returns {number} Time in seconds as offset from the start.
   */
  getCurrentTime() {
    return this.sound.currentTime;
  }

  /**
   * Returns the total duration in seconds.
   *
   * @returns {number} Time in seconds of fragment duration. 0 if no audio is loaded.
   */
  getDuration() {
    let duration = this.sound.duration;
    // When no audio is loaded, the duration may be NaN
    if (!duration) {
      duration = 0;
    }
    return duration;
  }

  /**
   * Returns state of the player.
   *
   * @returns {boolean} True when player is currently playing. False when paused or stopped.
   */
  isPlaying() {
    return !this.sound.paused;
  }

  /**
   * Returns ready state of the player.
   *
   * @returns {boolean} True when player is ready to start loading data or play. False when no audio is loaded
   * or preparing.
   */
  canPlay() {
    // Either the player is in a valid readyState (preloaded), or
    // the player has a source attached and doesn&apos;t show any loading error (non-preloaded).
    return this.sound.readyState &gt;= this.sound.HAVE_METADATA ||
      this.sound.src &amp;&amp; !this.sound.error;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
